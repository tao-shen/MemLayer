# 记忆检索与流式输出功能

## ✅ 已实现的功能

### 1. 基于记忆的 RAG（检索增强生成）

**功能说明**：
- 当用户提问时，系统会自动检索相关的历史记忆
- 将检索到的记忆作为上下文提供给 AI
- AI 会在回答中明确说明参考了哪些记忆

**实现细节**：
```javascript
// 检索相关记忆（基于关键词相似度）
function retrieveRelevantMemories(query, sessionId, topK = 3) {
  // 1. 过滤当前 session 的记忆
  // 2. 计算相似度
  // 3. 返回 top-K 最相关的记忆
}
```

**系统提示词格式**：
```
你是一个具有记忆能力的AI助手。

📚 相关记忆：

1. [EPISODIC] (14天前, 重要性:0.95)
   用户首次询问如何开发具有记忆能力的 AI Agent

2. [SEMANTIC] (13天前, 重要性:0.96)
   AI Agent 的记忆系统包含四种类型：STM、Episodic、Semantic、Reflection

请基于这些记忆来回答用户的问题。在回答开始时，简要说明你参考了哪些记忆。
```

### 2. 流式输出（打字机效果）

**功能说明**：
- AI 回复会逐字显示，模拟打字效果
- 提升用户体验，让等待过程更自然

**实现方式**：
```javascript
// 后端：逐字发送
const words = aiResponse.split('');
for (let i = 0; i < words.length; i++) {
  currentText += words[i];
  if (i % 5 === 0 || i === words.length - 1) {
    io.to(sessionId).emit('message:chunk', {
      id: aiMessage.id,
      content: currentText,
      done: i === words.length - 1
    });
    await new Promise(resolve => setTimeout(resolve, 20));
  }
}
```

**前端显示**：
- `streamingMessage` 状态存储正在输出的内容
- 临时创建一个 "streaming" 消息显示在列表中
- 完成后替换为正式消息

## 📊 两个预设场景

### Session 1: AI Agent 记忆系统学习之旅
- 16条对话
- 17条记忆（2 STM + 6 Episodic + 6 Semantic + 3 Reflection）
- 10个实体
- 15条关系

### Session 2: AI/机器学习/深度学习入门之旅
- 24条对话
- 23条记忆（2 STM + 8 Episodic + 8 Semantic + 4 Reflection）
- 12个实体
- 15条关系

## 🎯 使用示例

### 测试记忆检索

在 Session 1 中提问：
```
"RAG 是怎么实现的？"
```

AI 会回答：
```
根据我们10天前讨论的 RAG 实现方法，我记得...

[然后给出详细回答，引用之前的对话内容]
```

在 Session 2 中提问：
```
"我应该学习深度学习还是传统机器学习？"
```

AI 会回答：
```
根据我们10天前讨论的技术对比，以及你对神经网络表现出的浓厚兴趣...

[基于用户的学习历史和兴趣给出个性化建议]
```

## 🔧 技术实现

### 记忆检索算法
- **相似度计算**：基于关键词匹配（简单但有效）
- **过滤条件**：相似度 > 0.1
- **排序**：按相似度降序
- **返回数量**：Top-3 最相关记忆

### 记忆类型说明
1. **STM（短期记忆）**：最近的对话内容
2. **Episodic（情景记忆）**：具体的交互事件
3. **Semantic（语义记忆）**：抽象的知识概念
4. **Reflection（反思记忆）**：对用户的高层次洞察

### 流式输出参数
- **延迟**：20ms/chunk
- **批次大小**：5个字符/chunk
- **WebSocket 事件**：
  - `message:start` - 开始流式输出
  - `message:chunk` - 发送内容块
  - `message` - 完成输出

## 🚀 下一步优化

### 记忆检索
- [ ] 使用真实的向量相似度（需要 embedding 模型）
- [ ] 支持多模态检索（图片、代码等）
- [ ] 添加时间衰减因子（越新的记忆权重越高）
- [ ] 支持用户手动选择记忆

### 流式输出
- [ ] 支持 OpenAI 的真实流式 API
- [ ] 添加"停止生成"按钮
- [ ] 优化网络传输（使用 Server-Sent Events）
- [ ] 添加打字音效

### 可视化
- [ ] 在界面上显示检索到的记忆
- [ ] 高亮显示记忆中的关键词
- [ ] 显示记忆的相关性分数
- [ ] 记忆使用统计

## 📝 配置说明

### 环境变量
```bash
# .env.local
OPENAI_API_KEY=sk-...  # OpenAI API 密钥
```

### 服务端口
- 前端：http://localhost:5175
- 后端 API：http://localhost:3000
- WebSocket：ws://localhost:3000

## 🎨 用户体验

### 记忆联动示例
```
用户: "我之前问过什么？"

AI: "根据我们的对话记忆，你在14天前首次询问了如何开发具有记忆能力的 AI Agent。
之后我们深入讨论了：
- 记忆系统的四种类型
- 向量数据库的作用
- RAG 的实现方法
- 反思机制
- LangChain 框架

你展现出系统性学习的特点，从概念理解到技术细节，再到工具选择和实践应用。"
```

### 流式输出效果
```
用户: "解释一下深度学习"

AI: "深" → "深度" → "深度学" → "深度学习" → ...
[逐字显示，自然流畅]
```

## 🎉 总结

现在系统具备了：
1. ✅ 智能记忆检索 - AI 能记住并引用之前的对话
2. ✅ 流式输出 - 打字机效果，提升体验
3. ✅ 两个完整场景 - 丰富的示例数据
4. ✅ 真实 OpenAI 集成 - 支持真实 AI 回复

试试在不同的 session 中提问，看看 AI 如何基于记忆给出个性化的回答！🚀
