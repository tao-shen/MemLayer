// Prisma schema for Agent Memory Platform

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Agent {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  name      String   @db.VarChar(255)
  config    Json     @default("{}")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamp(6)

  sessions          Session[]
  memoryIndex       MemoryIndex[]
  workflows         Workflow[]
  behaviorStyles    BehaviorStyle[]
  extractedMemories ExtractedMemory[]
  rawData           RawData[]

  @@index([userId])
  @@index([createdAt(sort: Desc)])
  @@map("agents")
}

model Session {
  id        String    @id @default(uuid()) @db.Uuid
  agentId   String    @map("agent_id") @db.Uuid
  startedAt DateTime  @default(now()) @map("started_at") @db.Timestamp(6)
  endedAt   DateTime? @map("ended_at") @db.Timestamp(6)
  metadata  Json      @default("{}")

  agent Agent @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@index([agentId])
  @@index([startedAt(sort: Desc)])
  @@map("sessions")
}

model AuditLog {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  agentId   String?  @map("agent_id") @db.Uuid
  action    String   @db.VarChar(100)
  resource  String   @db.VarChar(255)
  timestamp DateTime @default(now()) @db.Timestamp(6)
  ipAddress String?  @map("ip_address") @db.Inet
  details   Json     @default("{}")

  @@index([userId])
  @@index([agentId])
  @@index([timestamp(sort: Desc)])
  @@index([action])
  @@map("audit_logs")
}

model MemoryIndex {
  id              String    @id @default(uuid()) @db.Uuid
  agentId         String    @map("agent_id") @db.Uuid
  memoryType      String    @map("memory_type") @db.VarChar(50)
  storageLocation String    @map("storage_location") @db.VarChar(255)
  importance      Decimal?  @db.Decimal(3, 2)
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamp(6)
  accessedAt      DateTime? @map("accessed_at") @db.Timestamp(6)
  accessCount     Int       @default(0) @map("access_count")
  metadata        Json      @default("{}")

  agent Agent @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@index([agentId])
  @@index([memoryType])
  @@index([importance(sort: Desc)])
  @@index([createdAt(sort: Desc)])
  @@index([accessedAt(sort: Desc)])
  @@map("memory_index")
}

// Vibe Agent: Workflow extraction
model Workflow {
  id          String   @id @default(uuid()) @db.Uuid
  agentId     String   @map("agent_id") @db.Uuid
  name        String   @db.VarChar(255)
  description String?  @db.Text
  version     Int      @default(1)
  graph       Json     // Workflow graph structure
  metadata    Json     @default("{}")
  statistics  Json     @default("{}")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamp(6)

  agent Agent @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@index([agentId])
  @@index([name])
  @@index([version])
  @@map("workflows")
}

// Vibe Agent: Behavior style extraction
model BehaviorStyle {
  id          String   @id @default(uuid()) @db.Uuid
  agentId     String   @map("agent_id") @db.Uuid
  version     Int      @default(1)
  style       Json     // BehaviorStyle object
  embedding   Json?    // Vector representation
  metadata    Json     @default("{}")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamp(6)

  agent Agent @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@index([agentId])
  @@index([version])
  @@map("behavior_styles")
}

// Vibe Agent: Extracted memory
model ExtractedMemory {
  id          String   @id @default(uuid()) @db.Uuid
  agentId     String   @map("agent_id") @db.Uuid
  type        String   @db.VarChar(50) // factual, procedural, episodic, semantic
  content     String   @db.Text
  summary     String?  @db.Text
  importance  Decimal  @db.Decimal(5, 2)
  embedding   Json?    // Vector embedding
  source      Json     // Source information
  usage       Json     @default("{}")
  metadata    Json     @default("{}")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamp(6)

  agent Agent @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@index([agentId])
  @@index([type])
  @@index([importance(sort: Desc)])
  @@index([createdAt(sort: Desc)])
  @@map("extracted_memories")
}

// Vibe Agent: Raw data for extraction
model RawData {
  id        String   @id @default(uuid()) @db.Uuid
  agentId   String?  @map("agent_id") @db.Uuid
  type      String   @db.VarChar(50) // conversation, code, document, log, api_call, feedback
  content   Json     // Raw content
  metadata  Json     @default("{}")
  context   Json?
  processed Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamp(6)

  agent Agent? @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@index([agentId])
  @@index([type])
  @@index([processed])
  @@index([createdAt(sort: Desc)])
  @@map("raw_data")
}

// Vibe Agent: Extraction jobs
model ExtractionJob {
  id          String   @id @default(uuid()) @db.Uuid
  agentId     String?  @map("agent_id") @db.Uuid
  status      String   @db.VarChar(50) // queued, processing, completed, failed
  progress    Json     @default("{}") // { workflow: 0-100, behavior: 0-100, memory: 0-100 }
  results     Json?    // Extraction results
  errors      Json?    // Error messages
  options     Json     @default("{}") // Extraction options
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamp(6)
  completedAt DateTime? @map("completed_at") @db.Timestamp(6)

  @@index([agentId])
  @@index([status])
  @@index([createdAt(sort: Desc)])
  @@map("extraction_jobs")
}

// Skill Creator: Skills
model Skill {
  id              String   @id @default(uuid()) @db.Uuid
  userId          String   @map("user_id") @db.Uuid
  name            String   @db.VarChar(255)
  description     String?  @db.Text
  category        String   @db.VarChar(50)
  icon            String?  @db.VarChar(10)
  color           String?  @db.VarChar(50)
  config          Json     @default("{}")
  sourceFiles     String[] @map("source_files")
  analysisContext Json?    @map("analysis_context")
  installCommand  String?  @map("install_command") @db.Text
  popularity      Int      @default(0)
  status          String   @default("draft") @db.VarChar(20)
  isPublic        Boolean  @default(false) @map("is_public")
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt       DateTime @updatedAt @map("updated_at") @db.Timestamp(6)
  lastUsedAt      DateTime? @map("last_used_at") @db.Timestamp(6)

  executions SkillExecution[]

  @@index([userId])
  @@index([category])
  @@index([status])
  @@index([createdAt(sort: Desc)])
  @@map("skills")
}

// Skill Creator: Uploaded files
model UploadedFile {
  id          String   @id @default(uuid()) @db.Uuid
  userId      String   @map("user_id") @db.Uuid
  fileName    String   @map("file_name") @db.VarChar(255)
  fileType    String?  @map("file_type") @db.VarChar(50)
  fileSize    Int?     @map("file_size")
  filePath    String   @map("file_path") @db.Text
  contentHash String?  @map("content_hash") @db.VarChar(64)
  status      String   @default("uploaded") @db.VarChar(20)
  uploadedAt  DateTime @default(now()) @map("uploaded_at") @db.Timestamp(6)

  @@index([userId])
  @@index([status])
  @@map("uploaded_files")
}

// Skill Creator: Skill executions
model SkillExecution {
  id         String   @id @default(uuid()) @db.Uuid
  skillId    String   @map("skill_id") @db.Uuid
  userId     String   @map("user_id") @db.Uuid
  input      String   @db.Text
  output     String?  @db.Text
  status     String   @db.VarChar(20)
  error      String?  @db.Text
  executedAt DateTime @default(now()) @map("executed_at") @db.Timestamp(6)
  duration   Int?     // milliseconds
  tokensUsed Int?     @map("tokens_used")

  skill Skill @relation(fields: [skillId], references: [id], onDelete: Cascade)

  @@index([skillId])
  @@index([userId])
  @@index([executedAt(sort: Desc)])
  @@map("skill_executions")
}
